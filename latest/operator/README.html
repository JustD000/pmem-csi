

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PMEM-CSI operator &mdash; PMEM-CSI  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Google Cloud Engine" href="../examples/gce.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> PMEM-CSI
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../README.html">Introduction to PMEM-CSI for Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/design.html">Design and architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/install.html">Instructions for Admins and Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/DEVELOPMENT.html">Develop and contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/autotest.html">Automated testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/readme.html">Application examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">PMEM-CSI operator</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#about">About</a></li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pre-requisites">Pre-requisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deploy-pmem-csi-operator">Deploy PMEM-CSI operator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deployment-crd-api">Deployment CRD API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#deployment">Deployment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploymentspec">DeploymentSpec</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploymentstatus">DeploymentStatus</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#driver-certificates">Driver certificates</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example-deployment">Example Deployment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/pmem-csi">Project GitHub repository</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PMEM-CSI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>PMEM-CSI operator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <!-- TOC --><ul class="simple">
<li><p><a class="reference external" href="#pmem-csi-for-kubernetes">PMEM-CSI Operator</a></p>
<ul>
<li><p><a class="reference external" href="#about">About</a></p></li>
<li><p><a class="reference external" href="#usage">Usage</a></p>
<ul>
<li><p><a class="reference external" href="#pre-requisites">Pre-requisites</a></p></li>
<li><p><a class="reference external" href="#deploy-pmem-csi-operator">Deploy PMEM-CSI operator</a></p></li>
<li><p><a class="reference external" href="#deployment-crd-api">Deployment CRD API</a></p></li>
<li><p><a class="reference external" href="#driver-certificates">Driver certificates</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#example-deployment">Example Deployment</a></p></li>
</ul>
</li>
</ul>
<!-- /TOC --><div class="section" id="pmem-csi-operator">
<h1>PMEM-CSI operator<a class="headerlink" href="#pmem-csi-operator" title="Permalink to this headline">¶</a></h1>
<div class="section" id="about">
<h2>About<a class="headerlink" href="#about" title="Permalink to this headline">¶</a></h2>
<p>PMEM-CSI operator facilitates deploying and managing the <a class="reference external" href="https://github.com/intel/pmem-csi">PMEM-CSI driver</a> on a Kubernetes cluster.</p>
<p>This operator is based on the CoreOS <a class="reference external" href="https://github.com/operator-framework/operator-sdk">operator-sdk</a> tools and APIs.</p>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pre-requisites">
<h3>Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline">¶</a></h3>
<p>A running Kubernetes cluster with one or more nodes installed with PMEM hardware(NVDIMM). The persistent memory on these nodes must be <a class="reference external" href="../README.html#persistent-memory-pre-provisioning">pre-provisioned</a>.</p>
</div>
<div class="section" id="deploy-pmem-csi-operator">
<h3>Deploy PMEM-CSI operator<a class="headerlink" href="#deploy-pmem-csi-operator" title="Permalink to this headline">¶</a></h3>
<!-- The assumptions:
  a) pmem-csi-operator binary is part of released intel/pmem-csi-driver image and no additional steps required to build the images
--><!--
  TODOs: Changes to below URL
    1) Current url is referring to 'operator' branch. so, when moved to devel branch change the url accordingly: 'raw/operator' ->  'raw/devel'
    2) Though currently operator deployments are in 'REPO_ROOT/operator/deploy', they must moved to 'REPO_ROOT/deploy'. Then that change should reflect in this url : 'operator/deploy' -> '/deploy'
    3) In release branch, branch name part of the url should point to appropriate release branch name
--><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ kubectl create -f https://github.com/intel/pmem-csi/raw/operator/operator/deploy/operator.yaml
</pre></div>
</div>
</div>
<div class="section" id="deployment-crd-api">
<h3>Deployment CRD API<a class="headerlink" href="#deployment-crd-api" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Deployment</span></code> is a cluster-scoped Kubernetes resource in the
<code class="docutils literal notranslate"><span class="pre">pmem-csi.intel.com</span></code> API group. It describes how a PMEM-CSI driver
instance is to be created.</p>
<p>The operator will create objects in the namespace in which the
operator itself runs unless the object type is not namespaced.</p>
<p>The name of the deployment object is also used as CSI driver
name. This ensures that the name is unique and immutable. However,
name clashes with other CSI drivers are still possible, so the name
should meet the <a class="reference external" href="https://github.com/container-storage-interface/spec/blob/master/spec.md#getplugininfo">CSI
requirements</a>:</p>
<ul class="simple">
<li><p>domain name notation format, including a unique top-level domain</p></li>
<li><p>63 characters or less, beginning and ending with an alphanumeric
character ([a-z0-9A-Z]) with dashes (-), dots (.), and
alphanumerics between.</p></li>
</ul>
<p>The name is also used as prefix for the names of all objects created
for the deployment and for the local <code class="docutils literal notranslate"><span class="pre">/var/lib/&lt;name&gt;</span></code> state directory
on each node.</p>
<p>The current API for PMEM-CSI <code class="docutils literal notranslate"><span class="pre">Deployment</span></code> resources is:</p>
<div class="section" id="deployment">
<h4>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<thead>
<tr>
<th>Field</th>
<th>type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>apiVersion</td>
<td>string</td>
<td><code>pmem-csi.intel.com/v1alpha1</code></td>
</tr>
<tr>
<td>kind</td>
<td>string</td>
<td><code>Deployment</code></td>
</tr>
<tr>
<td>metadata</td>
<td><a href="https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status">ObjectMeta</a></td>
<td>Object metadata, name used for CSI driver and as prefix for sub-objects</td>
</tr>
<tr>
<td>spec</td>
<td><a href="#deployment-spec">DeploymentSpec</a></td>
<td>Specification of the desired behavior of the deployment</td>
</tr>
</tbody>
</table></div>
<div class="section" id="deploymentspec">
<h4>DeploymentSpec<a class="headerlink" href="#deploymentspec" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<thead>
<tr>
<th>Field</th>
<th>type</th>
<th>Description</th>
<th>Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>image</td>
<td>string</td>
<td>PMEM-CSI docker image name used for the deployment</td>
<td>the same image as the operator<sup>1</sup></td>
</tr>
<tr>
<td>provisionerImage</td>
<td>string</td>
<td><a href="https://kubernetes-csi.github.io/docs/external-provisioner.html">CSI provisioner</a> docker image name</td>
<td>latest <a href="https://kubernetes-csi.github.io/docs/external-provisioner.html">external provisioner</a> stable release image<sup>2</sup></td>
</tr>
<tr>
<td>registrarImage</td>
<td>string</td>
<td><a href="https://github.com/kubernetes-csi/node-driver-registrar">CSI node driver registrar</a> docker image name</td>
<td>latest <a href="https://kubernetes-csi.github.io/docs/node-driver-registrar.html">node driver registrar</a> stable release image<sup>2</sup></td>
</tr>
<tr>
<td>pullPolicy</td>
<td>string</td>
<td>Docker image pull policy. either one of <code>Always</code>, <code>Never</code>, <code>IfNotPresent</code></td>
<td><code>IfNotPresent</code></td>
</tr>
<tr>
<td>logLevel</td>
<td>integer</td>
<td>PMEM-CSI driver logging level</td>
<td>3</td>
</tr>
<tr>
<td>deviceMode</td>
<td>string</td>
<td>Device management mode to use. Supports one of <code>lvm</code> or <code>direct</code></td>
<td><code>lvm</code></td>
</tr>
<tr>
<td>controllerResources</td>
<td><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#resourcerequirements-v1-core">ResourceRequirements</a></td>
<td>Describes the compute resource requirements for controller pod</td>
<td></td>
</tr>
<tr>
<td>nodeResources</td>
<td><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#resourcerequirements-v1-core">ResourceRequirements</a></td>
<td>Describes the compute resource requirements for the pods running on node(s)</td>
<td></td>
</tr>
<tr>
<td>registryCert</td>
<td>string</td>
<td>Encoded tls certificate signed by a certificate authority used for driver's controller registry server</td>
<td>generated by operator self-signed CA</td>
</tr>
<tr>
<td>nodeControllerCert</td>
<td>string</td>
<td>Encoded tls certificate signed by a certificate authority used for driver's node controllers</td>
<td>generated by operator self-signed CA</td>
</tr>
<tr>
<td>registryKey</td>
<td>string</td>
<td>Encoded RSA private key used for signing by <code>registryCert</code></td>
<td>generated by the operator</td>
</tr>
<tr>
<td>nodeControllerKey</td>
<td>string</td>
<td>Encoded RSA private key used for signing by <code>nodeControllerCert</code></td>
<td>generated by the operator</td>
</tr>
<tr>
<td>caCert</td>
<td>string</td>
<td>Certificate of the CA by which the <code>registryCert</code> and <code>controllerCert</code> are signed</td>
<td>self-signed certificate generated by the operator</td>
</tr>
<tr>
<td>nodeSelector</td>
<td>string map</td>
<td><a href="../README.md#run-pmem-csi-on-kubernetes">Labels to use for selecting Nodes</a> on which PMEM-CSI driver should run.</td>
<td><code>{ "storage": "pmem" }</code></td>
</tr>
<tr>
<td>pmemPercentage</td>
<td>integer</td>
<td>Percentage of PMEM space to be used by the driver on each node. This is only valid for a driver deployed in <code>lvm</code> mode. This field can be modified, but by that time the old value may have been used already. Reducing the percentage is not supported.</td>
<td>100</td>
</tr>
<tr>
<td>labels</td>
<td>string map</td>
<td>Additional labels for all objects created by the operator. Can be modified after the initial creation, but removed labels will not be removed from existing objects because the operator cannot know which labels it needs to remove and which it has to leave in place.</td>
<td></td>
</tr>
</tbody>
</table><p><sup>1</sup> To use the same container image as default driver image
the operator pod must set with below environment variables with
appropriate values:</p>
<ul class="simple">
<li><p>POD_NAME: Name of the operator pod. Namespace of the pod could be figured out by the operator.</p></li>
<li><p>OPERATOR_NAME: Name of the operator container. If not set, defaults to “pmem-csi-operator”</p></li>
</ul>
<p><sup>2</sup> Image versions depend on the Kubernetes release. The
operator dynamically chooses suitable image versions. Users have to
take care of that themselves when overriding the values.</p>
<p><strong>WARNING</strong>: although all fields can be modified and changes will be
propagated to the deployed driver, not all changes are safe. In
particular, changing the <code class="docutils literal notranslate"><span class="pre">deviceMode</span></code> will not work when there are
active volumes.</p>
</div>
<div class="section" id="deploymentstatus">
<h4>DeploymentStatus<a class="headerlink" href="#deploymentstatus" title="Permalink to this headline">¶</a></h4>
<p>A PMEM-CSI Deployment’s <code class="docutils literal notranslate"><span class="pre">status</span></code> field is a <code class="docutils literal notranslate"><span class="pre">DeploymentStatus</span></code> object, which has
a <code class="docutils literal notranslate"><span class="pre">phase</span></code> field. The phase of a Deployment is high-level summary of where the
Deployment is in it’s lifecycle.</p>
<p>The possible <code class="docutils literal notranslate"><span class="pre">phase</span></code> values and their meaning are as below:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>value</th>
<th>meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>empty string</td>
<td>A new deployment.</td>
</tr>
<tr>
<td>Initializing</td>
<td>All the direct sub-resources of the <code>Deployment</code> are created, but some indirect ones (like pods controlled by a daemon set) may still be missing.</td>
</tr>
<tr>
<td>Running</td>
<td>The operator has determined that the driver is usable<sup>1</sup>.</td>
</tr>
<tr>
<td>Failed</td>
<td>For some reason the state of the <code>Deployment</code> failed and cannot be progressed<sup>2</sup>.</td>
</tr>
</tbody>
</table><p><sup>1</sup> This check has not been implemented yet. Instead, the deployment goes straight to <code class="docutils literal notranslate"><span class="pre">Running</span></code> after creating sub-resources.
<sup>2</sup> Failure reason is supposed to be carried by one of additional <code class="docutils literal notranslate"><span class="pre">DeploymentStatus</span></code> field, but not implemented yet.</p>
</div>
</div>
<div class="section" id="driver-certificates">
<h3>Driver certificates<a class="headerlink" href="#driver-certificates" title="Permalink to this headline">¶</a></h3>
<p>All <a class="reference external" href="../README.html#security">PMEM-CSI driver communication is protected by mutual
TLS</a> to ensure that malicious or compromised entities in
the cluster cannot interfere with its operation. So the driver deployment needs
to be provided with those certificates and corresponding private keys using appropriate fields in deployment specification. These encoded certificates and private keys are made available to driver pods via Kubernetes <a class="reference external" href="https://kubernetes.io/docs/concepts/configuration/secret/">secrets</a> by the operator.</p>
<p>If the private keys and/or certificates data is missing in a deployment, the operator generates them using a self-signed CA.</p>
<p><strong>NOTE:</strong> A production deployment that is not supposed to depend on the operator’s self-signed CA instead must provide the certificates generated from a trusted certificate authority.</p>
</div>
</div>
<div class="section" id="example-deployment">
<h2>Example Deployment<a class="headerlink" href="#example-deployment" title="Permalink to this headline">¶</a></h2>
<p>Once the <a class="reference external" href="#deploy-PMEM-CSI-operator">operator deployed</a> is in <code class="docutils literal notranslate"><span class="pre">Running</span></code> state, it is ready to handle PMEM-CSI <code class="docutils literal notranslate"><span class="pre">Deployment</span></code> objects in <code class="docutils literal notranslate"><span class="pre">pmem-csi.intel.com</span></code> API group.</p>
<p>Here is an example driver deployment with custom driver image and pod resources:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ kubectl create -f - <span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: pmem-csi.intel.com/v1alpha1</span>
<span class="s">kind: Deployment</span>
<span class="s">metadata:</span>
<span class="s">  name: pmem-deployment</span>
<span class="s">spec:</span>
<span class="s">  image: localhost/pmem-csi-driver:canary</span>
<span class="s">  deviceMode: lvm</span>
<span class="s">  controllerResources:</span>
<span class="s">    requests:</span>
<span class="s">      cpu: &quot;200m&quot;</span>
<span class="s">      memory: &quot;100Mi&quot;</span>
<span class="s">  nodeResources:</span>
<span class="s">    requests:</span>
<span class="s">      cpu: &quot;200m&quot;</span>
<span class="s">      memory: &quot;100Mi&quot;</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>Once the above deployment installation is successful, we can see all the driver
pods in <code class="docutils literal notranslate"><span class="pre">Running</span></code> state:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ kubectl get deployments.pmem-csi.intel.com
NAME                 AGE
pmem-deployment      50s

$ kubectl describe deployment.pmem-csi.intel.com pmem-deployment
Name:         pmem-deployment
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  pmem-csi.intel.com/v1alpha1
Kind:         Deployment
Metadata:
  Creation Timestamp:  <span class="m">2020</span>-01-23T13:40:32Z
  Generation:          <span class="m">1</span>
  Resource Version:    <span class="m">3596387</span>
  Self Link:           /apis/pmem-csi.intel.com/v1alpha1/deployments/pmem-deployment
  UID:                 454b5961-5aa2-41c3-b774-29fe932ae236
Spec:
  Controller Resources:
    Requests:
      Cpu:      200m
      Memory:   100Mi
  Device Mode:  lvm
  Image:        localhost/pmem-csi-driver:canary
  Node Resources:
    Requests:
      Cpu:     200m
      Memory:  100Mi
Status:
  Phase:  Running
Events:   &lt;none&gt;

$ kubectl get po
NAME                               READY   STATUS    RESTARTS   AGE
pmem-deployment-controller-0       <span class="m">2</span>/2     Running   <span class="m">0</span>          51s
pmem-deployment-node-4x7cv         <span class="m">2</span>/2     Running   <span class="m">0</span>          50s
pmem-deployment-node-6grt6         <span class="m">2</span>/2     Running   <span class="m">0</span>          50s
pmem-deployment-node-msgds         <span class="m">2</span>/2     Running   <span class="m">0</span>          51s
pmem-csi-operator-749c7c7c69-k5k8n <span class="m">1</span>/1     Running   <span class="m">0</span>          3m
</pre></div>
</div>
<blockquote>
<div><p><strong>Note on multiple deployments</strong></p>
<p>Though the operator allows running multiple PMEM-CSI driver deployments, one
has to take extreme care of such deployments by ensuring that not more than
one driver ends up running on the same node(s). Nodes on which a PMEM-CSI
driver could run can be configured by using <code class="docutils literal notranslate"><span class="pre">nodeSelector</span></code> property of
<a class="reference external" href="#deployment-crd-api"><code class="docutils literal notranslate"><span class="pre">DeploymentSpec</span></code></a>.</p>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../examples/gce.html" class="btn btn-neutral float-left" title="Google Cloud Engine" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019,

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>